<!doctype html>
<html lang="it" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BereBeneHub â€“ v9.5.2 PRO (PWA offline)</title>
  <link rel="manifest" href="manifest.webmanifest?v=952">
  <meta name="theme-color" content="#0b0e14">
  <link rel="icon" href="icons/favicon-32.png" sizes="32x32">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <style>
    :root{
      --bg:#0b0e14; --card:#121826; --muted:#94a3b8; --text:#e5e7eb; --accent:#d4a373; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
      --radius:18px; --shadow:0 8px 28px rgba(0,0,0,.35); --paper:#ffffff; --ink:#0b0e14;
    }
    [data-theme="light"]{ --bg:#f7f7f9; --card:#ffffff; --muted:#4b5563; --text:#0b0e14; --accent:#b8742c; --paper:#ffffff; --ink:#0b0e14; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica Neue,Arial,Apple Color Emoji,Segoe UI Emoji;
      background:linear-gradient(180deg,var(--bg),var(--bg));color:var(--text)}
    .wrap{max-width:1200px;margin:32px auto;padding:0 16px 100px}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:16px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:48px;height:48px;border-radius:50%;display:grid;place-items:center;background:#0f172a;box-shadow:var(--shadow)}
    .ring{width:28px;height:28px;border:6px solid var(--accent);border-radius:50%;position:relative}
    .ring:after{content:"";position:absolute;inset:-10px;border-left:2px solid var(--text);transform:rotate(-35deg)}
    h1{font-size:22px;margin:0}
    .sub{color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:18px}
    .card{background:var(--card);border:1px solid #26314533;border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
    .card h2{font-size:16px;margin:0 0 12px 0}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input, textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #26314533;background:transparent;color:var(--text);outline:none}
    textarea{min-height:96px;resize:vertical}
    input:focus, textarea:focus{border-color:#3b82f6}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn{display:inline-block;margin-top:12px;padding:10px 14px;border-radius:12px;border:1px solid #26314533;background:#0f172a;color:var(--text);cursor:pointer}
    .btn:hover{filter:brightness(1.05)}
    .btn.accent{background:linear-gradient(180deg,#eab676,#c58b4a);color:#1b2636;border:none}
    .res{margin-top:12px;padding:10px 12px;border-radius:12px;background:#0f172a;border:1px dashed #26314533;font-variant-numeric:tabular-nums}
    .k{color:var(--muted)} .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    .small{font-size:12px;color:var(--muted)}
    footer{margin-top:32px;color:var(--muted);font-size:12px}
    .chip{display:inline-block;padding:4px 8px;border-radius:999px;background:#0f172a;border:1px solid #26314533;margin-right:6px}
    .toolbar{display:flex;align-items:center;gap:8px}
    .divider{height:1px;background:#26314533;margin:10px 0}
    table{width:100%;border-collapse:separate;border-spacing:0 6px}
    th, td{padding:8px 10px;background:#0f172a;border:1px solid #26314522;border-radius:8px;text-align:left;vertical-align:top}
    .right{display:flex;justify-content:flex-end}
    .banner{border:1px solid #3b82f6;color:#93c5fd;background:#1e293b;padding:10px 12px;border-radius:12px;margin-bottom:12px}
    .status{border:1px solid #26314533;background:#0f172a;color:#cbd5e1;padding:8px 10px;border-radius:10px;font-size:12px}
    .status b{color:#eab676}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo"><div class="ring"></div></div>
        <div>
          <h1>BereBeneHub â€“ v9.5.2 PRO</h1>
          <div class="sub">PWA offline â€¢ Import CSV â€¢ PDF PRO â€¢ Tema â€¢ Fix GitHub Pages</div>
        </div>
      </div>
      <div class="toolbar no-print">
        <button class="btn" id="themeToggle" title="Cambia tema">ðŸŒ“ Tema</button>
        <a class="btn" href="#" id="installBtn" style="display:none">âž• Installa App</a>
      </div>
    </header>

    <div class="no-print" id="pwaHint" style="display:none">
      <div class="banner">
        <b>Per Install App su GitHub Pages:</b> Attiva Pages su <i>Settings â†’ Pages</i> (main + /(root)). Attendi 1 minuto e ricarica. Su iPhone: <i>Share â†’ Add to Home Screen</i>.
      </div>
    </div>

    <div class="status no-print" id="status">Stato: inizializzazioneâ€¦</div>

    <div class="grid">
      <section class="card" id="importer">
        <h2>Importa ricette (CSV da Excel)</h2>
        <div class="small">Salva il tuo .xlsx come <b>CSV (UTFâ€‘8)</b> e importalo. Colonne: <b>Name</b>, <b>Ingredients</b>, <b>Steps</b>.</div>
        <input type="file" id="csvFile" accept=".csv" class="no-print">
        <div class="row">
          <div><button class="btn accent no-print" id="btnLoadCSV">Importa CSV</button></div>
          <div class="right"><button class="btn no-print" id="btnClear">Svuota archivio</button></div>
        </div>
        <div class="res" id="outImport">Archivio locale: <b id="count">0</b> ricette.</div>
      </section>

      <section class="card" id="dataset">
        <h2>Archivio ricette</h2>
        <div class="small">Dati salvati nel tuo browser (localStorage).</div>
        <div id="tblWrap"></div>
        <div class="row no-print">
          <div><button class="btn" id="btnExport">Esporta CSV</button></div>
          <div class="right"><button class="btn accent" id="btnPrintSel">PDF PRO delle selezionate</button></div>
        </div>
      </section>

      <section class="card" id="abv">
        <h2>ABV â€“ Target & Blend</h2>
        <div class="row">
          <div><label>ABV A (%)</label><input id="abvA" type="number" step="0.01" value="40"></div>
          <div><label>Volume A (mL)</label><input id="volA" type="number" step="0.1" value="700"></div>
        </div>
        <div class="row">
          <div><label>ABV B (%)</label><input id="abvB" type="number" step="0.01" value="0"></div>
          <div><label>Volume B (mL)</label><input id="volB" type="number" step="0.1" value="0"></div>
        </div>
        <div class="row">
          <div><label>Target ABV (%)</label><input id="abvT" type="number" step="0.01" value="20"></div>
          <div style="display:grid;align-items:end"><button class="btn accent" id="btnTarget">Calcola V<sub>B</sub></button></div>
        </div>
        <div><button class="btn" id="btnBlend">Calcola ABV di A+B</button> <button class="btn" id="btnResetAbv">Reset</button></div>
        <div class="res" id="outAbv">Pronto.</div>
      </section>

      <section class="card" id="brix">
        <h2>Brix â†” Zucchero</h2>
        <div class="row">
          <div><label>Brix (Â°Bx)</label><input id="bx" type="number" step="0.01" value="20"></div>
          <div style="display:grid;align-items:end"><button class="btn accent" id="btnBx">Converti</button></div>
        </div>
        <div class="res" id="outBx">Pronto.</div>
      </section>

      <section class="card" id="cost">
        <h2>Costo per Drink & Prezzo suggerito</h2>
        <div class="row">
          <div><label>Prezzo bottiglia (â‚¬)</label><input id="bottlePrice" type="number" step="0.01" value="20"></div>
          <div><label>Volume bottiglia (mL)</label><input id="bottleVol" type="number" step="0.1" value="700"></div>
        </div>
        <div class="row">
          <div><label>Pour per drink (mL)</label><input id="pour" type="number" step="0.1" value="50"></div>
          <div><label>Resa/Yield (%)</label><input id="yield" type="number" step="0.1" value="95"></div>
        </div>
        <div class="row">
          <div><label>Garnish (â‚¬)</label><input id="garnish" type="number" step="0.01" value="0.30"></div>
          <div><label>Altri costi (â‚¬)</label><input id="otherCost" type="number" step="0.01" value="0.20"></div>
        </div>
        <div><button class="btn accent" id="btnCost">Calcola</button> <button class="btn" id="btnResetCost">Reset</button></div>
        <div class="res" id="outCost">Pronto.</div>
      </section>

      <section class="card" id="dilution">
        <h2>Diluizione con ghiaccio â†’ ABV finale</h2>
        <div class="row">
          <div><label>ABV iniziale (%)</label><input id="dil_abv0" type="number" step="0.01" value="25"></div>
          <div><label>Diluizione (%)</label><input id="dil_pct" type="number" step="0.1" value="20"></div>
        </div>
        <div><button class="btn accent" id="btnDil">Calcola ABV finale</button></div>
        <div class="res" id="outDil">Pronto.</div>
      </section>

      <section class="card" id="batch">
        <h2>Batching â€“ scala ricetta</h2>
        <label>Ingredienti base</label>
        <textarea id="batch_ing" placeholder="30 mL, Gin
30 mL, Vermouth Rosso
30 mL, Bitter"></textarea>
        <div class="row">
          <div><label>Moltiplicatore (x)</label><input id="batch_m" type="number" step="0.1" value="10"></div>
          <div><label>Oppure Volume finale (mL)</label><input id="batch_V" type="number" step="0.1" value=""></div>
        </div>
        <div><button class="btn accent" id="btnBatch">Calcola batch</button></div>
        <div class="res" id="outBatch">Pronto.</div>
      </section>

      <section class="card" id="syrup">
        <h2>Sciroppo di zucchero â€“ target Brix</h2>
        <div class="row">
          <div><label>Target Brix (Â°Bx)</label><input id="sy_bx" type="number" step="0.1" value="50"></div>
          <div><label>Volume finale (mL)</label><input id="sy_vol" type="number" step="1" value="1000"></div>
        </div>
        <div><button class="btn accent" id="btnSy">Calcola sciroppo</button></div>
        <div class="res" id="outSy">Pronto.</div>
      </section>
    </div>

    <footer class="no-print">
      <span class="chip">v9.5.2 â€“ Fix GH Pages</span>
      <span class="chip">Cache: berebenehub-v9-5-2</span>
    </footer>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const f2 = (n) => Number(n).toFixed(2);
    const setStatus = (msg) => { const el=$('status'); if(el) el.innerHTML = msg; };

    document.addEventListener('DOMContentLoaded', () => {
      const root = document.documentElement;
      const saved = localStorage.getItem('theme'); if(saved) root.setAttribute('data-theme', saved);
      const tBtn = $('themeToggle'); if(tBtn){ tBtn.onclick = () => { const next=root.getAttribute('data-theme')==='dark'?'light':'dark'; root.setAttribute('data-theme',next); localStorage.setItem('theme',next); }; }

      const isFile = location.protocol === 'file:';
      if(isFile){ $('pwaHint').style.display='block'; setStatus('Stato: file:// (solo demo). Installa App via https:// (GitHub Pages).'); }
      else { setStatus('Stato: HTTPS. Controllo PWAâ€¦'); }

      let deferredPrompt;
      const installBtn = $('installBtn');
      window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt=e; if(installBtn) installBtn.style.display='inline-block'; setStatus('Stato: <b>Install App</b> disponibile.'); });
      if(installBtn){ installBtn.addEventListener('click', async () => { if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; installBtn.style.display='none'; }); }

      if('serviceWorker' in navigator && !isFile){
        navigator.serviceWorker.register('./sw.js?v=952').then(()=> setStatus('Stato: SW attivo. Offline OK.')).catch(err=> setStatus('Stato: <span class="err">SW non attivo</span>: '+err));
      }

      // Import/dataset and calculators are same as previous block; kept concise
      function loadData(){ try { return JSON.parse(localStorage.getItem('bbh_recipes_v1')||'[]'); } catch { return []; } }
      function saveData(arr){ localStorage.setItem('bbh_recipes_v1', JSON.stringify(arr)); }
      function updateCount(){ const c=$('count'); if(c) c.textContent = loadData().length; }
      function renderTable(){
        const data = loadData();
        if(!$('tblWrap')) return;
        if(data.length===0){ $('tblWrap').innerHTML = '<div class="small">Nessuna ricetta. Importa un CSV oppure aggiungi manualmente.</div>'; updateCount(); return; }
        $('tblWrap').innerHTML = `<table><thead><tr><th></th><th>Nome</th><th>Ingredienti</th><th>Istruzioni</th></tr></thead><tbody>${
          data.map((r,i)=>`<tr><td style="width:36px"><input type="checkbox" data-i="${i}" class="sel"></td><td><b>${(r.Name||'').replace(/</g,'&lt;')}</b></td><td>${(r.Ingredients||'').replace(/</g,'&lt;')}</td><td>${(r.Steps||'').replace(/</g,'&lt;')}</td></tr>`).join('')
        }</tbody></table>`;
        updateCount();
      }
      renderTable();

      $('btnLoadCSV').onclick = async () => { const f=$('csvFile').files[0]; if(!f){ $('outImport').innerHTML='<span class="warn">Seleziona un file CSV.</span>'; return; } const text=await f.text(); const rows=parseCSV(text); const objs=rowsToObjects(rows); const merged=loadData().concat(objs); saveData(merged); $('outImport').innerHTML='Importate <b>'+objs.length+'</b> ricette. Archivio totale: <b>'+merged.length+'</b>.'; renderTable(); };
      $('btnClear').onclick = () => { localStorage.removeItem('bbh_recipes_v1'); $('outImport').textContent='Archivio svuotato.'; renderTable(); };
      $('btnExport').onclick = () => { const data=loadData(); const header=['Name','Ingredients','Steps']; const lines=[header.join(',')].concat(data.map(r=>{ const esc=v=>'"'+String(v).replace(/"/g,'""')+'"'; return [esc(r.Name),esc(r.Ingredients),esc(r.Steps)].join(','); })); const blob=new Blob([lines.join('\r\n')],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='berebenehub_recipes.csv'; a.click(); URL.revokeObjectURL(url); };
      $('btnPrintSel').onclick = () => { const data=loadData(); const checks=Array.from(document.querySelectorAll('.sel:checked')).map(ch=>+ch.dataset.i); const items=(checks.length?checks:data.map((_,i)=>i)).map(i=>data[i]); const html='<!doctype html><html><head><meta charset="utf-8"><title>PDF â€“ Ricette</title><style>@page{size:A4;margin:16mm}body{font:12pt system-ui;color:#111}.card{page-break-inside:avoid;border:2px solid #333;border-radius:14px;padding:12px;margin:0 0 14px 0}h2{margin:0 0 6px 0;font-size:16pt}.row{display:flex;gap:14px}.col{flex:1}ul{margin:6px 0 0 18px}</style></head><body>'+items.map(it=>'<div class="card"><h2>'+String(it.Name||'Untitled').replace(/</g,'&lt;')+'</h2><div class="row"><div class="col"><b>Ingredienti</b><ul>'+String(it.Ingredients||'').split(/\n+/).filter(Boolean).map(x=>'<li>'+x.replace(/</g,'&lt;')+'</li>').join('')+'</ul></div><div class="col"><b>Istruzioni</b><div>'+String(it.Steps||'').replace(/</g,'&lt;').replace(/\n/g,'<br>')+'</div></div></div></div>').join('')+'<script>window.onload=()=>window.print()</script></body></html>'; const w=window.open('','_blank'); w.document.write(html); w.document.close(); };

      function parseCSV(text){ const rows=[]; let i=0,field='',row=[],inQuotes=false; while(i<text.length){ const c=text[i]; if(inQuotes){ if(c=='"'){ if(text[i+1]=='"'){ field+='"'; i++; } else { inQuotes=false; } } else { field+=c; } } else { if(c=='"'){ inQuotes=true; } else if(c==','){ row.push(field); field=''; } else if(c=='\n'||c=='\r'){ if(field!==''||row.length>0){ row.push(field); rows.push(row); row=[]; field=''; } if(c=='\r'&&text[i+1]=='\n') i++; } else { field+=c; } } i++; } if(field!==''||row.length>0){ row.push(field); rows.push(row); } return rows; }
      function rowsToObjects(rows){ if(rows.length===0) return []; const header=rows[0].map(h=>h.trim()); const idxName=header.findIndex(h=>/^name$/i.test(h)); const idxIng=header.findIndex(h=>/^ingredients?$/i.test(h)); const idxStep=header.findIndex(h=>/^steps?$/i.test(h)); return rows.slice(1).map(r=>({Name:idxName>=0?(r[idxName]||'').trim():'',Ingredients:idxIng>=0?(r[idxIng]||'').trim():'',Steps:idxStep>=0?(r[idxStep]||'').trim():''})).filter(x=>x.Name); }
    });
  </script>
</body>
</html>
